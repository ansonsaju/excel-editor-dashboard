<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Editor Pro</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #FFF8EB 0%, #F5EFE6 50%, #E8DCC8 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
        }
        .header-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid #E8DCC8;
        }
        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(to right, #6D776E, #D4A574);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        .subtitle {
            color: #6D776E;
            font-weight: 500;
            margin-bottom: 20px;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
        }
        button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(to right, #6D776E, #D4A574);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary {
            background: white;
            color: #6D776E;
            border: 2px solid #D4A574;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button:disabled:hover {
            transform: none;
        }
        .empty-state {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 60px;
            text-align: center;
            border: 1px solid #E8DCC8;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .empty-state h2 {
            font-size: 2rem;
            color: #2C3E2F;
            margin: 20px 0 12px;
        }
        .empty-state p {
            color: #6D776E;
            font-size: 1.125rem;
            margin-bottom: 24px;
        }
        .filter-section {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid #E8DCC8;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .search-box {
            position: relative;
            margin-bottom: 16px;
        }
        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 2px solid #E8DCC8;
            border-radius: 12px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.8);
        }
        .search-box input:focus {
            outline: none;
            border-color: #D4A574;
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.1);
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        .filter-item label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #6D776E;
            margin-bottom: 6px;
        }
        .filter-item select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #E8DCC8;
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.8);
        }
        .filter-item select:focus {
            outline: none;
            border-color: #D4A574;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        thead {
            background: linear-gradient(to right, #6D776E, #D4A574);
            color: white;
        }
        th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            font-size: 14px;
        }
        td {
            padding: 12px 16px;
            border-bottom: 1px solid #E8DCC8;
        }
        tr:hover {
            background: rgba(255, 248, 235, 0.5);
        }
        input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #E8DCC8;
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.8);
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #D4A574;
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.1);
        }
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .hidden {
            display: none;
        }
        .view-toggle {
            display: inline-flex;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid #E8DCC8;
        }
        .view-toggle button {
            padding: 8px 16px;
            background: transparent;
            color: #6D776E;
            border: none;
            border-radius: 8px;
        }
        .view-toggle button.active {
            background: linear-gradient(to right, #6D776E, #D4A574);
            color: white;
        }
        .card-view {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 32px;
            border: 1px solid #E8DCC8;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .card-field {
            margin-bottom: 20px;
            padding: 12px;
            border-bottom: 1px solid #E8DCC8;
            border-radius: 12px;
            transition: background 0.2s;
        }
        .card-field:hover {
            background: rgba(255, 248, 235, 0.5);
        }
        .card-field label {
            display: block;
            font-weight: 700;
            color: #2C3E2F;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .card-nav {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 24px;
            border: 1px solid #E8DCC8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .delete-btn {
            background: #ef4444;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }
        .delete-btn:hover {
            background: #dc2626;
        }
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #D4A574;
            border-radius: 12px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }
        .suggestion-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #E8DCC8;
        }
        .suggestion-item:hover {
            background: #FFF8EB;
        }
        .suggestion-badge {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 700;
        }
        .badge-common {
            background: #D4A574;
            color: white;
        }
        .badge-recent {
            background: #6D776E;
            color: white;
        }
        .badge-avg {
            background: #3b82f6;
            color: white;
        }
        input[type="checkbox"] {
            accent-color: #D4A574;
            width: 16px;
            height: 16px;
        }
        .checkbox-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border: 1px solid #E8DCC8;
            cursor: pointer;
            font-size: 14px;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .icon {
            width: 48px;
            height: 48px;
            color: #D4A574;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-card">
            <div class="header-top">
                <div class="header-left">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <line x1="9" y1="3" x2="9" y2="21"/>
                        <line x1="15" y1="3" x2="15" y2="21"/>
                        <line x1="3" y1="9" x2="21" y2="9"/>
                        <line x1="3" y1="15" x2="21" y2="15"/>
                    </svg>
                    <div>
                        <h1>Excel Editor Pro</h1>
                        <p class="subtitle">Professional Data Management System</p>
                    </div>
                </div>
                <div class="header-right">
                    <label class="checkbox-label">
                        <input type="checkbox" id="autoSave" checked>
                        <span>Auto-save</span>
                    </label>
                    <div class="view-toggle">
                        <button id="tableViewBtn" class="active">üìä Table</button>
                        <button id="cardViewBtn">üìá Card</button>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                <button id="uploadBtn" class="btn-primary">üì§ Upload File</button>
                <button id="downloadBtn" class="btn-secondary" disabled>üì• Download</button>
                <button id="undoBtn" class="btn-secondary" disabled>‚Ü∂ Undo</button>
                <button id="redoBtn" class="btn-secondary" disabled>‚Ü∑ Redo</button>
                <button id="addRowBtn" class="btn-primary" disabled>‚ûï Add Row</button>
                <button id="historyBtn" class="btn-secondary">üïê Files</button>
            </div>
        </div>

        <div id="filterSection" class="filter-section hidden">
            <div class="search-box">
                <input type="text" id="globalSearch" placeholder="Search across all columns...">
            </div>
            <div id="filterContainer" class="filter-grid"></div>
        </div>

        <div id="historyPanel" class="filter-section hidden">
            <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #2C3E2F;">Saved Files</h3>
                <button id="clearHistoryBtn" style="color: #ef4444; background: none; border: none; padding: 4px 12px;">Clear All</button>
            </div>
            <div id="historyList"></div>
        </div>

        <div id="emptyState" class="empty-state">
            <svg style="width: 96px; height: 96px; color: #D4A574; margin: 0 auto;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
            </svg>
            <h2>No Data Yet</h2>
            <p>Upload an Excel file to start managing your data</p>
            <button id="emptyStateBtn" class="btn-primary" style="font-size: 1.125rem; padding: 16px 32px;">Choose File</button>
        </div>

        <div id="cardViewContainer" class="hidden">
            <div class="card-nav">
                <div id="cardCounter" style="font-weight: 700; color: #2C3E2F;">Card 1 of 0</div>
                <div style="display: flex; gap: 12px;">
                    <button id="prevCard" class="btn-secondary">‚Üê Previous</button>
                    <button id="deleteCard" class="delete-btn">üóëÔ∏è Delete</button>
                    <button id="nextCard" class="btn-primary">Next ‚Üí</button>
                </div>
            </div>
            <div id="cardContent" class="card-view"></div>
        </div>

        <div id="tableViewContainer" class="hidden">
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toastContainer" style="position: fixed; top: 24px; right: 24px; z-index: 1000;"></div>

    <script>
let workbook = null, data = [], headers = [], history = [], historyIndex = -1;
let filters = {}, searchTerm = '', currentCardIndex = 0, isCardView = false;
let autoSave = true, currentFileName = '', customSuggestions = {}, saveTimeout = null;

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `<strong>${type === 'success' ? '‚úì' : '‚úó'}</strong> ${message}`;
    document.getElementById('toastContainer').appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

async function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    currentFileName = file.name;
    try {
        const arrayBuffer = await file.arrayBuffer();
        workbook = XLSX.read(arrayBuffer);
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
        if (jsonData.length > 0) {
            headers = Object.keys(jsonData[0]);
            data = jsonData;
            history = [JSON.parse(JSON.stringify(data))];
            historyIndex = 0;
            filters = {}; searchTerm = ''; currentCardIndex = 0;
            analyzeDataForSuggestions();
            saveFileHistory();
            render();
            showToast('File uploaded successfully!');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error loading file', 'error');
    }
}

function analyzeDataForSuggestions() {
    customSuggestions = {};
    headers.forEach(header => {
        const values = data.map(row => row[header]).filter(v => v !== '' && v !== '-');
        const valueCounts = {};
        values.forEach(v => valueCounts[v] = (valueCounts[v] || 0) + 1);
        const sorted = Object.entries(valueCounts).sort((a, b) => b[1] - a[1]).slice(0, 8).map(([val, count]) => ({ value: val, count }));
        const recent = [...new Set(values.slice(-5))].map(val => ({ value: val }));
        const numericValues = values.filter(v => !isNaN(v) && v !== '').map(Number);
        if (numericValues.length > 2) {
            const avg = numericValues.reduce((a, b) => a + b, 0) / numericValues.length;
            customSuggestions[header] = { frequent: sorted, recent, avg: Math.round(avg * 100) / 100 };
        } else {
            customSuggestions[header] = { frequent: sorted, recent };
        }
    });
}

function getSuggestionsForField(header) {
    const fieldSuggestions = customSuggestions[header];
    if (!fieldSuggestions) return [];
    const allSuggestions = [];
    fieldSuggestions.frequent?.forEach(item => {
        allSuggestions.push({ value: item.value, label: `${item.value}`, badge: 'Common', count: item.count, class: 'badge-common' });
    });
    fieldSuggestions.recent?.forEach(item => {
        if (!allSuggestions.find(s => s.value === item.value)) {
            allSuggestions.push({ value: item.value, label: `${item.value}`, badge: 'Recent', class: 'badge-recent' });
        }
    });
    if (fieldSuggestions.avg && !allSuggestions.find(s => s.value === fieldSuggestions.avg)) {
        allSuggestions.push({ value: fieldSuggestions.avg, label: `${fieldSuggestions.avg} (Avg)`, badge: 'Average', class: 'badge-avg' });
    }
    return allSuggestions.slice(0, 12);
}

function updateCell(rowIndex, header, value) {
    data[rowIndex][header] = value;
    addToHistory();
    analyzeDataForSuggestions();
    render();
    debouncedSave();
}

function addToHistory() {
    const newHistory = history.slice(0, historyIndex + 1);
    newHistory.push(JSON.parse(JSON.stringify(data)));
    if (newHistory.length > 50) newHistory.shift();
    else historyIndex = newHistory.length - 1;
    history = newHistory;
    updateButtons();
}

function undo() {
    if (historyIndex > 0) {
        historyIndex--;
        data = JSON.parse(JSON.stringify(history[historyIndex]));
        render();
        showToast('Undo successful');
    }
}

function redo() {
    if (historyIndex < history.length - 1) {
        historyIndex++;
        data = JSON.parse(JSON.stringify(history[historyIndex]));
        render();
        showToast('Redo successful');
    }
}

function addRow() {
    const newRow = {};
    headers.forEach(h => newRow[h] = '');
    data.push(newRow);
    addToHistory();
    render();
    showToast('Row added');
    if (isCardView) {
        currentCardIndex = getFilteredData().length - 1;
        renderCardView();
    }
}

function deleteRow(index) {
    if (confirm('Delete this row?')) {
        data.splice(index, 1);
        addToHistory();
        render();
        showToast('Row deleted');
    }
}

function handleDownload() {
    if (data.length === 0) return;
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    const fileName = currentFileName ? currentFileName.replace('.xlsx', `_edited_${Date.now()}.xlsx`) : `edited_${Date.now()}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showToast('File downloaded successfully!');
}

function saveFileHistory() {
    const fileHistory = JSON.parse(localStorage.getItem('excelFileHistory') || '[]');
    const fileEntry = {
        fileName: currentFileName,
        timestamp: new Date().toISOString(),
        rows: data.length,
        state: { data, headers, filters, searchTerm, currentCardIndex, isCardView }
    };
    const existingIndex = fileHistory.findIndex(f => f.fileName === currentFileName);
    if (existingIndex >= 0) fileHistory.splice(existingIndex, 1);
    fileHistory.unshift(fileEntry);
    localStorage.setItem('excelFileHistory', JSON.stringify(fileHistory.slice(0, 10)));
}

function saveToStorage() {
    if (!autoSave || data.length === 0) return;
    if (currentFileName) {
        const fileHistory = JSON.parse(localStorage.getItem('excelFileHistory') || '[]');
        if (fileHistory.length > 0) {
            fileHistory[0].state = { data, headers, filters, searchTerm, currentCardIndex, isCardView };
            localStorage.setItem('excelFileHistory', JSON.stringify(fileHistory));
        }
    }
}

function debouncedSave() {
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => saveToStorage(), 1000);
}

function getFilteredData() {
    return data.filter(row => {
        const matchesFilters = Object.entries(filters).every(([key, value]) => String(row[key]) === String(value));
        const matchesSearch = searchTerm === '' || Object.values(row).some(val => String(val).toLowerCase().includes(searchTerm.toLowerCase()));
        return matchesFilters && matchesSearch;
    });
}

function updateButtons() {
    document.getElementById('undoBtn').disabled = historyIndex <= 0;
    document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
    document.getElementById('downloadBtn').disabled = data.length === 0;
    document.getElementById('addRowBtn').disabled = data.length === 0;
}

function render() {
    updateButtons();
    if (data.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('tableViewContainer').classList.add('hidden');
        document.getElementById('cardViewContainer').classList.add('hidden');
        document.getElementById('filterSection').classList.add('hidden');
        return;
    }
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('filterSection').classList.remove('hidden');
    renderFilters();
    if (isCardView) {
        document.getElementById('tableViewContainer').classList.add('hidden');
        document.getElementById('cardViewContainer').classList.remove('hidden');
        renderCardView();
    } else {
        document.getElementById('cardViewContainer').classList.add('hidden');
        document.getElementById('tableViewContainer').classList.remove('hidden');
        renderTableView();
    }
}

function renderFilters() {
    document.getElementById('filterContainer').innerHTML = headers.map(header => {
        const uniqueValues = [...new Set(data.map(row => row[header]))].filter(v => v !== '' && v !== '-').sort();
        return `<div class="filter-item"><label>${header}</label><select onchange="updateFilter('${header}', this.value)"><option value="">All (${uniqueValues.length})</option>${uniqueValues.slice(0, 100).map(val => `<option value="${val}" ${filters[header] === val ? 'selected' : ''}>${val}</option>`).join('')}</select></div>`;
    }).join('');
}

function updateFilter(header, value) {
    if (value === '') delete filters[header];
    else filters[header] = value;
    currentCardIndex = 0;
    render();
}

function renderCardView() {
    const filtered = getFilteredData();
    document.getElementById('cardCounter').textContent = `Card ${currentCardIndex + 1} of ${filtered.length}`;
    if (filtered.length === 0) {
        document.getElementById('cardContent').innerHTML = '<p style="text-align: center; color: #6D776E; padding: 32px;">No data matches your filters</p>';
        return;
    }
    const row = filtered[currentCardIndex];
    const originalIndex = data.indexOf(row);
    document.getElementById('cardContent').innerHTML = headers.map(header => 
        `<div class="card-field"><label>${header}</label>${renderCellInput(originalIndex, header, row[header])}</div>`
    ).join('');
}

function renderTableView() {
    const filtered = getFilteredData();
    document.getElementById('tableHeader').innerHTML = `<th>Actions</th>${headers.map(h => `<th>${h}</th>`).join('')}`;
    if (filtered.length === 0) {
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="${headers.length + 1}" style="text-align: center; padding: 48px; color: #6D776E;">No data matches your filters</td></tr>`;
        return;
    }
    document.getElementById('tableBody').innerHTML = filtered.map(row => {
        const originalIndex = data.indexOf(row);
        return `<tr><td><button class="delete-btn" onclick="deleteRow(${originalIndex})">üóëÔ∏è</button></td>${headers.map(header => 
            `<td><div style="min-width: 120px; max-width: 200px;">${renderCellInput(originalIndex, header, row[header])}</div></td>`
        ).join('')}</tr>`;
    }).join('');
}

function renderCellInput(rowIndex, header, value) {
    const inputId = `input-${rowIndex}-${header}`;
    const suggestions = getSuggestionsForField(header);
    return `<div style="position: relative;"><input type="text" id="${inputId}" value="${value || ''}" onchange="updateCell(${rowIndex}, '${header}', this.value)" ${suggestions.length > 0 ? `onfocus="showSuggestions('${inputId}')"` : ''}>${suggestions.length > 0 ? `<div id="suggestions-${inputId}" class="suggestions-dropdown hidden">${suggestions.map(s => `<div class="suggestion-item" onclick="applySuggestion(${rowIndex}, '${header}', '${s.value}', '${inputId}')"><span>${s.label}</span><span class="suggestion-badge ${s.class}">${s.badge}${s.count ? ` (${s.count})` : ''}</span></div>`).join('')}</div>` : ''}</div>`;
}

function showSuggestions(inputId) {
    document.querySelectorAll('.suggestions-dropdown').forEach(el => el.classList.add('hidden'));
    const suggestionsEl = document.getElementById(`suggestions-${inputId}`);
    if (suggestionsEl) suggestionsEl.classList.remove('hidden');
}

function applySuggestion(rowIndex, header, value, inputId) {
    updateCell(rowIndex, header, value);
    const suggestionsEl = document.getElementById(`suggestions-${inputId}`);
    if (suggestionsEl) suggestionsEl.classList.add('hidden');
}

document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('fileInput');
    document.getElementById('uploadBtn').addEventListener('click', () => fileInput.click());
    document.getElementById('emptyStateBtn').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileUpload);
    document.getElementById('downloadBtn').addEventListener('click', handleDownload);
    document.getElementById('undoBtn').addEventListener('click', undo);
    document.getElementById('redoBtn').addEventListener('click', redo);
    document.getElementById('addRowBtn').addEventListener('click', addRow);
    document.getElementById('historyBtn').addEventListener('click', () => {
        const panel = document.getElementById('historyPanel');
        panel.classList.toggle('hidden');
        if (!panel.classList.contains('hidden')) {
            const fileHistory = JSON.parse(localStorage.getItem('excelFileHistory') || '[]');
            document.getElementById('historyList').innerHTML = fileHistory.length === 0 ? '<p style="text-align: center; color: #6D776E; padding: 32px;">No saved files</p>' : fileHistory.map((item, idx) => {
                const date = new Date(item.timestamp);
                const seconds = Math.floor((new Date() - date) / 1000);
                let timeAgo = 'Just now';
                const intervals = {year: 31536000, month: 2592000, week: 604800, day: 86400, hour: 3600, minute: 60};
                for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                    const interval = Math.floor(seconds / secondsInUnit);
                    if (interval >= 1) {
                        timeAgo = `${interval} ${unit}${interval !== 1 ? 's' : ''} ago`;
                        break;
                    }
                }
                return `<div onclick="loadHistoryItem(${idx})" style="padding: 16px; background: rgba(255,255,255,0.8); border-radius: 12px; border: 2px solid #E8DCC8; cursor: pointer; margin-bottom: 12px;"><div style="display: flex; justify-content: space-between;"><div><p style="font-weight: 600; color: #2C3E2F;">${item.fileName}</p><p style="font-size: 12px; color: #6D776E;">${item.rows} rows</p></div><span style="font-size: 12px; color: #D4A574; font-weight: 600;">${timeAgo}</span></div></div>`;
            }).join('');
        }
    });
    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
        if (confirm('Clear all saved files? This cannot be undone.')) {
            localStorage.removeItem('excelFileHistory');
            document.getElementById('historyPanel').classList.add('hidden');
            showToast('History cleared');
        }
    });
    document.getElementById('autoSave').addEventListener('change', (e) => {
        autoSave = e.target.checked;
        if (autoSave && data.length > 0) saveToStorage();
    });
    document.getElementById('tableViewBtn').addEventListener('click', () => {
        isCardView = false;
        document.getElementById('tableViewBtn').classList.add('active');
        document.getElementById('cardViewBtn').classList.remove('active');
        render();
    });
    document.getElementById('cardViewBtn').addEventListener('click', () => {
        isCardView = true;
        document.getElementById('tableViewBtn').classList.remove('active');
        document.getElementById('cardViewBtn').classList.add('active');
        render();
    });
    document.getElementById('globalSearch').addEventListener('input', (e) => {
        searchTerm = e.target.value;
        render();
    });
    document.getElementById('prevCard').addEventListener('click', () => {
        if (currentCardIndex > 0) {
            currentCardIndex--;
            renderCardView();
        }
    });
    document.getElementById('nextCard').addEventListener('click', () => {
        const filtered = getFilteredData();
        if (currentCardIndex < filtered.length - 1) {
            currentCardIndex++;
            renderCardView();
        }
    });
    document.getElementById('deleteCard').addEventListener('click', () => {
        const filtered = getFilteredData();
        const row = filtered[currentCardIndex];
        const originalIndex = data.indexOf(row);
        deleteRow(originalIndex);
    });
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            undo();
        } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
            e.preventDefault();
            redo();
        } else if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            saveToStorage();
            showToast('Saved!');
        }
    });
    render();
});

function loadHistoryItem(index) {
    const fileHistory = JSON.parse(localStorage.getItem('excelFileHistory') || '[]');
    const item = fileHistory[index];
    const state = item.state;
    currentFileName = item.fileName;
    data = state.data || [];
    headers = state.headers || [];
    filters = state.filters || {};
    searchTerm = state.searchTerm || '';
    currentCardIndex = state.currentCardIndex || 0;
    isCardView = state.isCardView || false;
    history = [JSON.parse(JSON.stringify(data))];
    historyIndex = 0;
    if (data.length > 0) {
        analyzeDataForSuggestions();
        render();
        showToast(`Loaded: ${item.fileName}`);
    }
    document.getElementById('historyPanel').classList.add('hidden');
}
    </script>
</body>
</html>
