<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional Excel Editor with Intelligent Suggestions">
    <meta name="theme-color" content="#445c3f">
    <title>Excel Editor Pro - Professional Data Management</title>
    
    <!-- React & ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
        #root { min-height: 100vh; }
        
        /* Loading Animation */
        .loader { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            background: linear-gradient(135deg, #eceee3 0%, #ccd5b5 100%);
        }
        .loader-content { text-align: center; }
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #ccd5b5;
            border-top-color: #445c3f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #ccd5b5; }
        ::-webkit-scrollbar-thumb { background-color: #7d936c; border-radius: 4px; }
        * { scrollbar-width: thin; scrollbar-color: #7d936c #ccd5b5; }
    </style>
</head>
<body>
    <div id="root">
        <div class="loader">
            <div class="loader-content">
                <div class="loader-spinner"></div>
                <h2 style="color: #445c3f; font-size: 24px; margin-bottom: 10px;">Excel Editor Pro</h2>
                <p style="color: #7d936c;">Loading...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ExcelEditorPro = () => {
          const [workbook, setWorkbook] = useState(null);
          const [sheets, setSheets] = useState([]);
          const [activeSheet, setActiveSheet] = useState(0);
          const [data, setData] = useState([]);
          const [headers, setHeaders] = useState([]);
          const [history, setHistory] = useState([]);
          const [historyIndex, setHistoryIndex] = useState(-1);
          const [filters, setFilters] = useState({});
          const [searchTerm, setSearchTerm] = useState('');
          const [currentCardIndex, setCurrentCardIndex] = useState(0);
          const [isCardView, setIsCardView] = useState(false);
          const [autoSave, setAutoSave] = useState(true);
          const [currentFileName, setCurrentFileName] = useState('');
          const [showHistory, setShowHistory] = useState(false);
          const [numberSuggestions, setNumberSuggestions] = useState({});
          const [toast, setToast] = useState(null);
          const fileInputRef = useRef(null);

          const colors = {
            primary: '#445c3f',
            secondary: '#7d936c',
            tertiary: '#aab992',
            quaternary: '#ccd5b5',
            background: '#eceee3'
          };

          useEffect(() => {
            loadFromStorage();
            lucide.createIcons();
          }, []);

          useEffect(() => {
            if (data.length > 0) {
              analyzeDataForSuggestions();
            }
            lucide.createIcons();
          }, [data, isCardView]);

          const showToast = (message, type = 'success') => {
            setToast({ message, type });
            setTimeout(() => setToast(null), 3000);
          };

          const analyzeDataForSuggestions = () => {
            const suggestions = {};
            headers.forEach(header => {
              const values = data.map(row => row[header]).filter(v => v !== '' && v !== '-' && !isNaN(v));
              if (values.length > 2) {
                const numValues = values.map(Number);
                const sorted = [...numValues].sort((a, b) => a - b);
                const freq = {};
                numValues.forEach(v => freq[v] = (freq[v] || 0) + 1);
                const common = Object.entries(freq)
                  .sort((a, b) => b[1] - a[1])
                  .slice(0, 5)
                  .map(([val]) => Number(val));
                
                suggestions[header] = {
                  min: Math.min(...numValues),
                  max: Math.max(...numValues),
                  avg: numValues.reduce((a, b) => a + b, 0) / numValues.length,
                  median: sorted[Math.floor(sorted.length / 2)],
                  recent: numValues.slice(-5),
                  common: common,
                  frequency: freq
                };
              }
            });
            setNumberSuggestions(suggestions);
          };

          const generateIntelligentSuggestions = (header, currentValue) => {
            if (!numberSuggestions[header]) return [];
            
            const { min, max, avg, median, recent, common, frequency } = numberSuggestions[header];
            const suggestions = new Set();
            
            common.forEach(v => suggestions.add(Math.round(v * 100) / 100));
            recent.forEach(v => suggestions.add(Math.round(v * 100) / 100));
            suggestions.add(Math.round(avg * 100) / 100);
            suggestions.add(Math.round(median * 100) / 100);
            
            if (currentValue && !isNaN(currentValue) && currentValue !== '') {
              const num = Number(currentValue);
              [-10, -5, -3, -2, -1, 1, 2, 3, 5, 10].forEach(offset => {
                const val = num + offset;
                if (val >= min && val <= max) {
                  suggestions.add(Math.round(val * 100) / 100);
                }
              });
              
              [0.9, 0.95, 1.05, 1.1].forEach(multiplier => {
                const val = num * multiplier;
                if (val >= min && val <= max) {
                  suggestions.add(Math.round(val * 100) / 100);
                }
              });
            }
            
            const step = (max - min) / 20;
            for (let i = 0; i <= 20; i++) {
              suggestions.add(Math.round((min + step * i) * 100) / 100);
            }
            
            return Array.from(suggestions)
              .filter(v => v >= min && v <= max)
              .sort((a, b) => {
                const aFreq = frequency[a] || 0;
                const bFreq = frequency[b] || 0;
                const aRecent = recent.includes(a);
                const bRecent = recent.includes(b);
                const aCommon = common.includes(a);
                const bCommon = common.includes(b);
                
                if (aFreq !== bFreq) return bFreq - aFreq;
                if (aRecent !== bRecent) return bRecent - aRecent;
                if (aCommon !== bCommon) return bCommon - aCommon;
                return a - b;
              })
              .slice(0, 15);
          };

          const handleFileUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            setCurrentFileName(file.name);
            try {
              const arrayBuffer = await file.arrayBuffer();
              const wb = XLSX.read(arrayBuffer);
              setWorkbook(wb);
              const sheetNames = wb.SheetNames;
              setSheets(sheetNames);
              
              if (sheetNames.length > 0) {
                loadSheet(wb, 0, sheetNames);
                saveFileHistory(file.name, sheetNames, []);
                showToast('File uploaded successfully');
              }
            } catch (error) {
              console.error('Error:', error);
              showToast('Error loading file', 'error');
            }
          };

          const loadSheet = (wb, index, sheetNames) => {
            const ws = wb.Sheets[sheetNames[index]];
            const jsonData = XLSX.utils.sheet_to_json(ws, { defval: '' });
            
            if (jsonData.length > 0) {
              const hdrs = Object.keys(jsonData[0]);
              setHeaders(hdrs);
              setData(jsonData);
              setActiveSheet(index);
              setHistory([JSON.parse(JSON.stringify(jsonData))]);
              setHistoryIndex(0);
              setFilters({});
              setSearchTerm('');
              setCurrentCardIndex(0);
            }
          };

          const saveFileHistory = (fileName, sheetNames, currentData) => {
            const fileHistory = JSON.parse(localStorage.getItem('excelFileHistory') || '[]');
            const fileEntry = {
              fileName,
              timestamp: new Date().toISOString(),
              sheets: sheetNames.length,
              rows: currentData.length,
              state: { sheets: sheetNames, activeSheet, data: currentData, headers, filters, searchTerm, currentCardIndex, isCardView }
            };
            
            const existingIndex = fileHistory.findIndex(f => f.fileName === fileName);
            if (existingIndex >= 0) fileHistory.splice(existingIndex, 1);
            fileHistory.unshift(fileEntry);
            localStorage.setItem('excelFileHistory', JSON.stringify(fileHistory.slice(0, 10)));
          };

          const loadFromStorage = () => {
            try {
              const fileHistory = JSON.parse(localStorage.getItem('excelFileHistory') || '[]');
              if (fileHistory.length > 0) {
                const lastFile = fileHistory[0];
                loadFileFromHistory(lastFile.state, lastFile.fileName);
              }
            } catch (e) {
              console.error('Load error:', e);
            }
          };

          const loadFileFromHistory = (state, fileName) => {
            setCurrentFileName(fileName);
            setSheets(state.sheets || []);
            setActiveSheet(state.activeSheet || 0);
            setData(state.data || []);
            setHeaders(state.headers || []);
            setFilters(state.filters || {});
            setSearchTerm(state.searchTerm || '');
            setCurrentCardIndex(state.currentCardIndex || 0);
            setIsCardView(state.isCardView || false);
            setHistory([JSON.parse(JSON.stringify(state.data || []))]);
            setHistoryIndex(0);
            setShowHistory(false);
            showToast(`Loaded: ${fileName}`);
          };

          const getFilteredData = () => {
            return data.filter(row => {
              const matchesFilters = Object.entries(filters).every(([key, value]) => 
                String(row[key]) === String(value)
              );
              const matchesSearch = searchTerm === '' || Object.values(row).some(val =>
                String(val).toLowerCase().includes(searchTerm.toLowerCase())
              );
              return matchesFilters && matchesSearch;
            });
          };

          const updateCell = (rowIndex, header, value) => {
            if (rowIndex < 0 || rowIndex >= data.length) return;
            const newData = [...data];
            newData[rowIndex][header] = value;
            setData(newData);
            addToHistory(newData);
            if (autoSave && currentFileName) {
              saveFileHistory(currentFileName, sheets, newData);
            }
          };

          const addToHistory = (newData) => {
            const newHistory = history.slice(0, historyIndex + 1);
            newHistory.push(JSON.parse(JSON.stringify(newData)));
            setHistory(newHistory.slice(-50));
            setHistoryIndex(newHistory.length - 1);
          };

          const undo = () => {
            if (historyIndex > 0) {
              setHistoryIndex(historyIndex - 1);
              setData(JSON.parse(JSON.stringify(history[historyIndex - 1])));
              showToast('Undo successful');
            }
          };

          const redo = () => {
            if (historyIndex < history.length - 1) {
              setHistoryIndex(historyIndex + 1);
              setData(JSON.parse(JSON.stringify(history[historyIndex + 1])));
              showToast('Redo successful');
            }
          };

          const addRow = () => {
            const newRow = {};
            headers.forEach(h => newRow[h] = '');
            const newData = [...data, newRow];
            setData(newData);
            addToHistory(newData);
            if (isCardView) {
              const filtered = getFilteredData();
              setCurrentCardIndex(filtered.length);
            }
            showToast('Row added');
          };

          const deleteRow = (index) => {
            if (window.confirm('Delete this row?')) {
              const newData = data.filter((_, i) => i !== index);
              setData(newData);
              addToHistory(newData);
              const filtered = getFilteredData();
              if (currentCardIndex >= filtered.length) {
                setCurrentCardIndex(Math.max(0, filtered.length - 1));
              }
              showToast('Row deleted');
            }
          };

          const handleDownload = () => {
            if (data.length === 0) return;
            const wb = XLSX.utils.book_new();
            sheets.forEach((sheetName, idx) => {
              const wsData = idx === activeSheet ? data : [];
              const ws = XLSX.utils.json_to_sheet(wsData);
              XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            const fileName = currentFileName 
              ? currentFileName.replace('.xlsx', `_edited_${Date.now()}.xlsx`)
              : `edited_${Date.now()}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast('File downloaded');
          };

          const isNumericField = (header) => {
            const numericKeywords = ['height', 'weight', 'chest', 'hip', 'bmi', 'age', 'size', 'number', 'count', 'amount', 'price', 'cost', 'total', 'score'];
            return numericKeywords.some(keyword => header.toLowerCase().includes(keyword)) && numberSuggestions[header];
          };

          const SuggestionDropdown = ({ header, rowIndex, value, onSelect }) => {
            const suggestions = generateIntelligentSuggestions(header, value);
            
            return (
              <div className="suggestion-dropdown" style={{
                position: 'absolute',
                zIndex: 50,
                marginTop: '4px',
                width: '100%',
                backgroundColor: 'white',
                borderRadius: '8px',
                boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                maxHeight: '256px',
                overflowY: 'auto',
                border: `2px solid ${colors.primary}`
              }}>
                <div style={{
                  position: 'sticky',
                  top: 0,
                  background: `linear-gradient(135deg, ${colors.primary}, ${colors.secondary})`,
                  color: 'white',
                  padding: '8px 12px',
                  fontSize: '12px',
                  fontWeight: 600,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  <i data-lucide="sparkles" style={{ width: '14px', height: '14px' }}></i>
                  Smart Suggestions
                </div>
                {suggestions.map((s, idx) => {
                  const isCommon = numberSuggestions[header]?.common.includes(s);
                  const isRecent = numberSuggestions[header]?.recent.includes(s);
                  const freq = numberSuggestions[header]?.frequency[s] || 0;
                  
                  return (
                    <div
                      key={idx}
                      onClick={() => onSelect(s)}
                      style={{
                        padding: '8px 12px',
                        cursor: 'pointer',
                        transition: 'all 0.15s',
                        borderBottom: `1px solid ${colors.quaternary}`
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = colors.background;
                        e.currentTarget.style.paddingLeft = '16px';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = 'white';
                        e.currentTarget.style.paddingLeft = '12px';
                      }}
                    >
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <span style={{ fontWeight: 500, fontSize: '14px', color: colors.primary }}>{s}</span>
                        <div style={{ display: 'flex', gap: '4px' }}>
                          {freq > 0 && (
                            <span style={{
                              fontSize: '10px',
                              padding: '2px 8px',
                              borderRadius: '12px',
                              backgroundColor: colors.secondary,
                              color: 'white'
                            }}>
                              {freq}x
                            </span>
                          )}
                          {isCommon && (
                            <span style={{
                              fontSize: '10px',
                              padding: '2px 8px',
                              borderRadius: '12px',
                              backgroundColor: colors.tertiary,
                              color: 'white'
                            }}>
                              Common
                            </span>
                          )}
                          {isRecent && (
                            <span style={{
                              fontSize: '10px',
                              padding: '2px 8px',
                              borderRadius: '12px',
                              backgroundColor: colors.quaternary,
                              color: colors.primary
                            }}>
                              Recent
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            );
          };

          const CellInput = ({ rowIndex, header, value, isCard }) => {
            const [showSugg, setShowSugg] = useState(false);
            const [inputValue, setInputValue] = useState(value);
            const isNumeric = isNumericField(header);

            const handleSelect = (suggValue) => {
              setInputValue(suggValue);
              updateCell(rowIndex, header, suggValue);
              setShowSugg(false);
              
              if (isCard) {
                const currentIndex = headers.indexOf(header);
                if (currentIndex < headers.length - 1) {
                  setTimeout(() => {
                    const nextInput = document.querySelector(`input[data-row="${rowIndex}"][data-header="${headers[currentIndex + 1]}"]`);
                    if (nextInput) nextInput.focus();
                  }, 100);
                }
              }
            };

            return (
              <div style={{ position: 'relative' }}>
                <input
                  type={isNumeric ? 'number' : 'text'}
                  value={inputValue}
                  data-row={rowIndex}
                  data-header={header}
                  onChange={(e) => {
                    setInputValue(e.target.value);
                    updateCell(rowIndex, header, e.target.value);
                  }}
                  onFocus={() => isNumeric && setShowSugg(true)}
                  onBlur={() => setTimeout(() => setShowSugg(false), 200)}
                  style={{
                    width: '100%',
                    padding: isCard ? '10px 12px' : '8px 12px',
                    border: `2px solid ${colors.quaternary}`,
                    borderRadius: '8px',
                    fontSize: isCard ? '16px' : '14px',
                    transition: 'all 0.2s',
                    outline: 'none'
                  }}
                  onFocusCapture={(e) => {
                    e.target.style.borderColor = colors.primary;
                    e.target.style.boxShadow = `0 0 0 3px ${colors.quaternary}40`;
                  }}
                  onBlurCapture={(e) => {
                    e.target.style.borderColor = colors.quaternary;
                    e.target.style.boxShadow = 'none';
                  }}
                  placeholder={`Enter ${header}`}
                />
                {showSugg && isNumeric && (
                  <SuggestionDropdown
                    header={header}
                    rowIndex={rowIndex}
                    value={inputValue}
                    onSelect={handleSelect}
                  />
                )}
              </div>
            );
          };

          const JapaneseArtDecoration = () => (
            <div style={{
              position: 'fixed',
              inset: 0,
              pointerEvents: 'none',
              opacity: 0.05,
              zIndex: 0
            }}>
              <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <pattern id="bamboo" x="0" y="0" width="200" height="200" patternUnits="userSpaceOnUse">
                    <path d="M50,20 Q60,60 50,100 Q40,140 50,180" stroke={colors.primary} strokeWidth="3" fill="none" />
                    <circle cx="50" cy="50" r="8" fill={colors.secondary} opacity="0.3" />
                    <circle cx="50" cy="150" r="8" fill={colors.secondary} opacity="0.3" />
                  </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#bamboo)" />
              </svg>
            </div>
          );

          return (
            <div style={{
              minHeight: '100vh',
              padding: '16px 24px',
              position: 'relative',
              overflow: 'hidden',
              backgroundColor: colors.background
            }}>
              <JapaneseArtDecoration />
              
              <div style={{ maxWidth: '1280px', margin: '0 auto', position: 'relative', zIndex: 10 }}>
                {/* Header */}
                <div style={{
                  borderRadius: '16px',
                  boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                  padding: '24px',
                  marginBottom: '24px',
                  backdropFilter: 'blur(8px)',
                  backgroundColor: `${colors.background}f5`,
                  border: `2px solid ${colors.quaternary}`
                }}>
                  <div style={{
                    display: 'flex',
                    flexDirection: window.innerWidth < 1024 ? 'column' : 'row',
                    alignItems: window.innerWidth < 1024 ? 'flex-start' : 'center',
                    justifyContent: 'space-between',
                    gap: '16px',
                    marginBottom: '24px'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                      <div style={{
                        width: '64px',
                        height: '64px',
                        borderRadius: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                        background: `linear-gradient(135deg, ${colors.primary}, ${colors.secondary})`
                      }}>
                        <svg width="32" height="32" viewBox="0 0 100 100" fill="none">
                          <rect x="20" y="30" width="25" height="40" fill="white" opacity="0.9" />
                          <rect x="50" y="20" width="30" height="60" fill="white" opacity="0.7" />
                          <circle cx="70" cy="15" r="8" fill="#ff6b6b" />
                        </svg>
                      </div>
                      <div>
                        <h1 style={{ fontSize: '36px', fontWeight: 'bold', marginBottom: '4px', color: colors.primary }}>
                          Excel Editor Pro
                        </h1>
                        <p style={{ fontSize: '14px', color: colors.secondary }}>
                          Professional Data Management â€¢ Intelligent Suggestions
                        </p>
                      </div>
                    </div>
                    
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flexWrap: 'wrap' }}>
                      <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        fontSize: '14px',
                        fontWeight: 500,
                        cursor: 'pointer',
                        color: colors.primary
                      }}>
                        <input
                          type="checkbox"
                          checked={autoSave}
                          onChange={(e) => setAutoSave(e.target.checked)}
                          style={{ borderRadius: '4px' }}
                        />
                        Auto-save
                      </label>
                      
                      <div style={{
                        display: 'flex',
                        borderRadius: '12px',
                        padding: '4px',
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                        backgroundColor: 'white'
                      }}>
                        <button
                          onClick={() => setIsCardView(false)}
                          style={{
                            padding: '8px 16px',
                            borderRadius: '8px',
                            fontWeight: 500,
                            fontSize: '14px',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            border: 'none',
                            cursor: 'pointer',
                            backgroundColor: !isCardView ? colors.primary : 'transparent',
                            color: !isCardView ? 'white' : colors.primary,
                            boxShadow: !isCardView ? '0 4px 6px -1px rgba(0, 0, 0, 0.1)' : 'none'
                          }}
                        >
                          <i data-lucide="grid" style={{ width: '16px', height: '16px' }}></i>
                          Table
                        </button>
                        <button
                          onClick={() => setIsCardView(true)}
                          style={{
                            padding: '8px 16px',
                            borderRadius: '8px',
                            fontWeight: 500,
                            fontSize: '14px',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            border: 'none',
                            cursor: 'pointer',
                            backgroundColor: isCardView ? colors.primary : 'transparent',
                            color: isCardView ? 'white' : colors.primary,
                            boxShadow: isCardView ? '0 4px 6px -1px rgba(0, 0, 0, 0.1)' : 'none'
                          }}
                        >
                          <i data-lucide="credit-card" style={{ width: '16px', height: '16px' }}></i>
                          Card
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '12px' }}>
                    <button
                      onClick={() => fileInputRef.current?.click()}
                      style={{
                        padding: '12px 24px',
                        borderRadius: '8px',
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                        fontWeight: 500,
                        fontSize: '14px',
                        color: 'white',
                        transition: 'all 0.3s',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        border: 'none',
                        cursor: 'pointer',
                        background: `linear-gradient(135deg, ${colors.primary}, ${colors.secondary})`
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1)';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1)';
                      }}
                    >
                      <i data-lucide="upload" style={{ width: '18px', height: '18px' }}></i>
                      Upload
                    </button>
                    <input
                      ref={fileInputRef}
                      type="file"
                      accept=".xlsx,.xls"
                      onChange={handleFileUpload}
                      style={{ display: 'none' }}
                    />
                    
                    <button
                      onClick={handleDownload}
                      disabled={data.length === 0}
                      style={{
                        padding: '12px 24px',
                        borderRadius: '8px',
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                        fontWeight: 500,
                        fontSize: '14px',
                        transition: 'all 0.3s',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        border: `2px solid ${colors.quaternary}`,
                        cursor: data.length === 0 ? 'not-allowed' : 'pointer',
                        backgroundColor: 'white',
                        color: colors.primary,
                        opacity: data.length === 0 ? 0.5 : 1
                      }}
                    >
                      <i data-lucide="download" style={{ width: '18px', height: '18px' }}></i>
                      Download
                    </button>
                    
                    <button
                      onClick={undo}
                      disabled={historyIndex <= 0}
                      title="Undo"
                      style={{
                        padding: '12px',
                        borderRadius: '8px',
                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                        border: `2px solid ${colors.quaternary}`,
                        transition: 'all 0.3s',
                        cursor: historyIndex <= 0 ? 'not-allowed' : 'pointer',
                        backgroundColor: 'white',
                        color: colors.primary,
                        opacity: historyIndex <= 0 ? 0.5 : 1
                      }}
                    >
                      <i data-lucide="undo" style={{ width: '18px', height: '18px' }}></i>
                    </button>
                    
                    <button
                      onClick={redo}
                      disabled={historyIndex >= history.length - 1}
                      title="Redo"
                      style={{
                        padding: '12px',
                        borderRadius: '8px',
                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                        border: `2px solid ${colors.quaternary}`,
                        transition: 'all 0.3s',
                        cursor: historyIndex >= history.length - 1 ? 'not-allowed' : 'pointer',
                        backgroundColor: 'white',
                        color: colors.primary,
                        opacity: historyIndex >= history.length - 1 ? 0.5 : 1
                      }}
                    >
                      <i data-lucide="redo" style={{ width: '18px', height: '18px' }}></i>
                    </button>
                    
                    <button
                      onClick={addRow}
                      disabled={data.length === 0}
                      style={{
                        padding: '12px 24px',
                        borderRadius: '8px',
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                        fontWeight: 500,
                        fontSize: '14px',
                        color: 'white',
                        transition: 'all 0.3s',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        border: 'none',
                        cursor: data.length === 0 ? 'not-allowed' : 'pointer',
                        background: `linear-gradient(135deg, ${colors.primary}, ${colors.secondary})`,
                        opacity: data.length === 0 ? 0.5 : 1
                      }}
                    >
                      <i data-lucide="plus" style={{ width: '18px', height: '18px' }}></i>
                      Add Row
                    </button>
                    
                    <button
                      onClick={() => setShowHistory(!showHistory)}
                      style={{
                        padding: '12px 24px',
                        borderRadius: '8px',
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                        fontWeight: 500,
                        fontSize: '14px',
                        transition: 'all 0.3s',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        border: `2px solid ${colors.quaternary}`,
                        cursor: 'pointer',
                        backgroundColor: 'white',
                        color: colors.primary
                      }}
                    >
                      <i data-lucide="clock" style={{ width: '18px', height: '18px' }}></i>
                      Files
                    </button>
                  </div>
                </div>

                {/* Search and Filters */}
                {data.length > 0 && (
                  <div style={{
                    borderRadius: '12px',
                    boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                    padding: '16px',
                    marginBottom: '16px',
                    backdropFilter: 'blur(8px)',
                    backgroundColor: `${colors.background}f5`,
                    border: `1px solid ${colors.quaternary}`
                  }}>
                    <div style={{ position: 'relative', marginBottom: '16px' }}>
                      <i data-lucide="search" style={{
                        position: 'absolute',
                        left: '12px',
                        top: '12px',
                        width: '18px',
                        height: '18px',
                        color: colors.secondary
                      }}></i>
                      <input
                        type="text"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        placeholder="Search across all fields..."
                        style={{
                          width: '100%',
                          paddingLeft: '40px',
                          paddingRight: '16px',
                          paddingTop: '8px',
                          paddingBottom: '8px',
                          border: `2px solid ${colors.quaternary}`,
                          borderRadius: '8px',
                          outline: 'none',
                          fontSize: '14px'
                        }}
                        onFocus={(e) => {
                          e.target.style.borderColor = colors.primary;
                          e.target.style.boxShadow = `0 0 0 3px ${colors.quaternary}40`;
                        }}
                        onBlur={(e) => {
                          e.target.style.borderColor = colors.quaternary;
                          e.target.style.boxShadow = 'none';
                        }}
                      />
                    </div>
                    
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                      gap: '12px'
                    }}>
                      {headers.map(header => {
                        const uniqueValues = [...new Set(data.map(row => row[header]))].filter(v => v !== '' && v !== '-').sort();
                        return (
                          <div key={header}>
                            <label style={{
                              display: 'block',
                              fontSize: '12px',
                              fontWeight: 500,
                              marginBottom: '6px',
                              overflow: 'hidden',
                              textOverflow: 'ellipsis',
                              whiteSpace: 'nowrap',
                              color: colors.primary
                            }} title={header}>
                              {header}
                            </label>
                            <select
                              onChange={(e) => {
                                const newFilters = { ...filters };
                                if (e.target.value === '') delete newFilters[header];
                                else newFilters[header] = e.target.value;
                                setFilters(newFilters);
                              }}
                              style={{
                                width: '100%',
                                padding: '8px',
                                border: `2px solid ${colors.quaternary}`,
                                borderRadius: '8px',
                                outline: 'none',
                                fontSize: '12px',
                                cursor: 'pointer'
                              }}
                            >
                              <option value="">All ({uniqueValues.length})</option>
                              {uniqueValues.slice(0, 100).map(val => (
                                <option key={val} value={val}>{val}</option>
                              ))}
                            </select>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Table View */}
                {!isCardView && data.length > 0 && (
                  <div style={{
                    borderRadius: '12px',
                    boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                    overflow: 'hidden',
                    backdropFilter: 'blur(8px)',
                    backgroundColor: `${colors.background}f5`,
                    border: `2px solid ${colors.quaternary}`
                  }}>
                    <div style={{ overflowX: 'auto' }}>
                      <table style={{ width: '100%', fontSize: '14px', borderCollapse: 'collapse' }}>
                        <thead style={{
                          background: `linear-gradient(135deg, ${colors.primary}, ${colors.secondary})`,
                          color: 'white'
                        }}>
                          <tr>
                            <th style={{
                              padding: '12px',
                              textAlign: 'left',
                              fontWeight: 600,
                              position: 'sticky',
                              top: 0,
                              zIndex: 10
                            }}>
                              Actions
                            </th>
                            {headers.map(h => (
                              <th key={h} style={{
                                padding: '12px',
                                textAlign: 'left',
                                fontWeight: 600,
                                whiteSpace: 'nowrap',
                                position: 'sticky',
                                top: 0,
                                zIndex: 10
                              }}>
                                <div style={{
                                  minWidth: '100px',
                                  maxWidth: '200px',
                                  overflow: 'hidden',
                                  textOverflow: 'ellipsis'
                                }} title={h}>
                                  {h}
                                </div>
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {getFilteredData().map((row, idx) => {
                            const originalIndex = data.indexOf(row);
                            return (
                              <tr key={idx} style={{
                                borderBottom: `1px solid ${colors.quaternary}`,
                                transition: 'background-color 0.2s'
                              }}
                              onMouseEnter={(e) => e.currentTarget.style.backgroundColor = `${colors.quaternary}40`}
                              onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                              >
                                <td style={{ padding: '8px 12px' }}>
                                  <button
                                    onClick={() => deleteRow(originalIndex)}
                                    style={{
                                      color: '#ef4444',
                                      padding: '4px',
                                      borderRadius: '4px',
                                      border: 'none',
                                      cursor: 'pointer',
                                      backgroundColor: 'transparent',
                                      transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                      e.currentTarget.style.backgroundColor = '#fee2e2';
                                      e.currentTarget.style.color = '#dc2626';
                                    }}
                                    onMouseLeave={(e) => {
                                      e.currentTarget.style.backgroundColor = 'transparent';
                                      e.currentTarget.style.color = '#ef4444';
                                    }}
                                  >
                                    <i data-lucide="trash-2" style={{ width: '16px', height: '16px' }}></i>
                                  </button>
                                </td>
                                {headers.map(header => (
                                  <td key={header} style={{ padding: '8px 12px' }}>
                                    <div style={{
                                      minWidth: '100px',
                                      maxWidth: '200px'
                                    }}>
                                      <CellInput
                                        rowIndex={originalIndex}
                                        header={header}
                                        value={row[header]}
                                        isCard={false}
                                      />
                                    </div>
                                  </td>
                                ))}
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Card View */}
                {isCardView && data.length > 0 && (
                  <>
                    <div style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      borderRadius: '12px',
                      boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                      padding: '16px',
                      marginBottom: '16px',
                      backdropFilter: 'blur(8px)',
                      backgroundColor: `${colors.background}f5`,
                      border: `1px solid ${colors.quaternary}`
                    }}>
                      <div style={{ fontWeight: 600, color: colors.primary }}>
                        Card {currentCardIndex + 1} of {getFilteredData().length}
                      </div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <button
                          onClick={() => setCurrentCardIndex(Math.max(0, currentCardIndex - 1))}
                          disabled={currentCardIndex === 0}
                          style={{
                            padding: '8px 16px',
                            borderRadius: '8px',
                            boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                            border: `2px solid ${colors.quaternary}`,
                            transition: 'all 0.3s',
                            cursor: currentCardIndex === 0 ? 'not-allowed' : 'pointer',
                            backgroundColor: 'white',
                            color: colors.primary,
                            opacity: currentCardIndex === 0 ? 0.5 : 1,
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                          }}
                        >
                          <i data-lucide="chevron-left" style={{ width: '18px', height: '18px' }}></i>
                          Prev
                        </button>
                        <button
                          onClick={() => {
                            const filteredData = getFilteredData();
                            const row = filteredData[currentCardIndex];
                            const originalIndex = data.indexOf(row);
                            deleteRow(originalIndex);
                          }}
                          style={{
                            padding: '8px 16px',
                            borderRadius: '8px',
                            boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                            backgroundColor: '#ef4444',
                            color: 'white',
                            transition: 'all 0.3s',
                            cursor: 'pointer',
                            border: 'none',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                          }}
                          onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#dc2626'}
                          onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#ef4444'}
                        >
                          <i data-lucide="trash-2" style={{ width: '18px', height: '18px' }}></i>
                          Delete
                        </button>
                        <button
                          onClick={() => setCurrentCardIndex(Math.min(getFilteredData().length - 1, currentCardIndex + 1))}
                          disabled={currentCardIndex === getFilteredData().length - 1}
                          style={{
                            padding: '8px 16px',
                            borderRadius: '8px',
                            boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                            color: 'white',
                            transition: 'all 0.3s',
                            cursor: currentCardIndex === getFilteredData().length - 1 ? 'not-allowed' : 'pointer',
                            background: `linear-gradient(135deg, ${colors.primary}, ${colors.secondary})`,
                            opacity: currentCardIndex === getFilteredData().length - 1 ? 0.5 : 1,
                            border: 'none',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                          }}
                        >
                          Next
                          <i data-lucide="chevron-right" style={{ width: '18px', height: '18px' }}></i>
                        </button>
                      </div>
                    </div>
                    
                    <div style={{
                      borderRadius: '12px',
                      boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                      padding: '32px',
                      backdropFilter: 'blur(8px)',
                      backgroundColor: `${colors.background}f5`,
                      border: `2px solid ${colors.quaternary}`
                    }}>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        {headers.map(header => {
                          const filteredData = getFilteredData();
                          const row = filteredData[currentCardIndex];
                          const originalIndex = data.indexOf(row);
                          
                          return (
                            <div key={header} style={{
                              borderBottom: `1px solid ${colors.quaternary}`,
                              paddingBottom: '12px',
                              padding: '8px',
                              borderRadius: '8px',
                              transition: 'background-color 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = `${colors.quaternary}20`}
                            onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                            >
                              <label style={{
                                display: 'block',
                                fontSize: '14px',
                                fontWeight: 600,
                                marginBottom: '8px',
                                color: colors.primary
                              }}>
                                {header}
                              </label>
                              <CellInput
                                rowIndex={originalIndex}
                                header={header}
                                value={row[header]}
                                isCard={true}
                              />
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </>
                )}

                {/* Empty State */}
                {data.length === 0 && (
                  <div style={{
                    borderRadius: '12px',
                    boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                    padding: '64px 32px',
                    textAlign: 'center',
                    backdropFilter: 'blur(8px)',
                    backgroundColor: `${colors.background}f5`,
                    border: `2px solid ${colors.quaternary}`
                  }}>
                    <div style={{
                      width: '96px',
                      height: '96px',
                      margin: '0 auto 16px',
                      borderRadius: '16px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                      background: `linear-gradient(135deg, ${colors.secondary}, ${colors.tertiary})`
                    }}>
                      <svg width="48" height="48" viewBox="0 0 100 100" fill="none">
                        <rect x="20" y="30" width="25" height="40" fill="white" opacity="0.9" />
                        <rect x="50" y="20" width="30" height="60" fill="white" opacity="0.7" />
                        <circle cx="70" cy="15" r="8" fill="#ff6b6b" />
                      </svg>
                    </div>
                    <h2 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '8px', color: colors.primary }}>
                      No Data Yet
                    </h2>
                    <p style={{ marginBottom: '16px', color: colors.secondary }}>
                      Upload an Excel file to start managing your data
                    </p>
                    <button
                      onClick={() => fileInputRef.current?.click()}
                      style={{
                        padding: '12px 24px',
                        borderRadius: '8px',
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                        fontWeight: 500,
                        color: 'white',
                        transition: 'all 0.3s',
                        border: 'none',
                        cursor: 'pointer',
                        background: `linear-gradient(135deg, ${colors.primary}, ${colors.secondary})`
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1)';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1)';
                      }}
                    >
                      Choose File
                    </button>
                  </div>
                )}

                {/* History Panel Modal */}
                {showHistory && (
                  <div style={{
                    position: 'fixed',
                    inset: 0,
                    backgroundColor: 'rgba(0, 0, 0, 0.5)',
                    zIndex: 50,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '16px'
                  }} onClick={() => setShowHistory(false)}>
                    <div style={{
                      borderRadius: '12px',
                      boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                      padding: '24px',
                      maxWidth: '672px',
                      width: '100%',
                      maxHeight: '80vh',
                      overflowY: 'auto',
                      backdropFilter: 'blur(8px)',
                      backgroundColor: colors.background,
                      border: `2px solid ${colors.quaternary}`
                    }} onClick={(e) => e.stopPropagation()}>
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '16px'
                      }}>
                        <h3 style={{ fontSize: '18px', fontWeight: 'bold', color: colors.primary }}>
                          Saved Files
                        </h3>
                        <button
                          onClick={() => setShowHistory(false)}
                          style={{
                            padding: '8px',
                            borderRadius: '8px',
                            border: 'none',
                            cursor: 'pointer',
                            backgroundColor: 'transparent',
                            color: colors.primary,
                            transition: 'background-color 0.2s'
                          }}
                          onMouseEnter={(e) => e.currentTarget.style.backgroundColor = `${colors.quaternary}40`}
                          onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                        >
                          <i data-lucide="x" style={{ width: '20px', height: '20px' }}></i>
                        </button>
                      </div>
                      
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {JSON.parse(localStorage.getItem('excelFileHistory') || '[]').map((item, idx) => {
                          const date = new Date(item.timestamp);
                          const timeAgo = (() => {
                            const seconds = Math.floor((new Date() - date) / 1000);
                            const intervals = { year: 31536000, month: 2592000, week: 604800, day: 86400, hour: 3600, minute: 60 };
                            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                              const interval = Math.floor(seconds / secondsInUnit);
                              if (interval >= 1) return `${interval} ${unit}${interval !== 1 ? 's' : ''} ago`;
                            }
                            return 'Just now';
                          })();
                          
                          return (
                            <div
                              key={idx}
                              onClick={() => loadFileFromHistory(item.state, item.fileName)}
                              style={{
                                padding: '12px',
                                backgroundColor: 'white',
                                borderRadius: '8px',
                                border: `2px solid ${colors.quaternary}`,
                                cursor: 'pointer',
                                transition: 'all 0.3s'
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.borderColor = colors.primary;
                                e.currentTarget.style.transform = 'translateX(4px)';
                                e.currentTarget.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.borderColor = colors.quaternary;
                                e.currentTarget.style.transform = 'translateX(0)';
                                e.currentTarget.style.boxShadow = 'none';
                              }}
                            >
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                <div style={{ flex: 1, minWidth: 0 }}>
                                  <p style={{
                                    fontWeight: 600,
                                    fontSize: '14px',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                    whiteSpace: 'nowrap',
                                    color: colors.primary
                                  }}>
                                    {item.fileName}
                                  </p>
                                  <p style={{ fontSize: '12px', color: colors.secondary }}>
                                    {item.sheets} sheet{item.sheets > 1 ? 's' : ''} â€¢ {item.rows} rows
                                  </p>
                                </div>
                                <span style={{
                                  fontSize: '12px',
                                  whiteSpace: 'nowrap',
                                  marginLeft: '8px',
                                  color: colors.tertiary
                                }}>
                                  {timeAgo}
                                </span>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}

                {/* Toast Notification */}
                {toast && (
                  <div style={{
                    position: 'fixed',
                    top: '20px',
                    right: '20px',
                    zIndex: 9999,
                    padding: '12px 20px',
                    borderRadius: '8px',
                    boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                    animation: 'slideIn 0.3s ease-out',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    color: 'white',
                    backgroundColor: toast.type === 'success' ? '#10b981' : '#ef4444'
                  }}>
                    {toast.type === 'success' ? (
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                      </svg>
                    ) : (
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                      </svg>
                    )}
                    <span>{toast.message}</span>
                  </div>
                )}
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExcelEditorPro />);
    </script>
</body>
</html>
